# Project Status — 2025-10-27

> Update (2025-11-04): This status note predates the milli-core migration. The default index is now milli-core with an automatic in-memory fallback; references to Tantivy as the default reflect historical context.

- Summary
  - Workspace scaffolded with all crates per spec.
  - Ephemeral storage works for basic save/get/delete in-memory.
  - Local, GitHub, Tantivy, SQLite, Crypto, Server are stubbed with typed errors/placeholders.
  - CLI (`gitmem`) runs and starts a placeholder stdio server with Ephemeral backend.
  - Proto crate defines MCP tool names and parameter schemas.

- Implemented
  - Core model, traits, and errors: `crates/core`
  - Proto tool schemas: `crates/proto`
  - Storage
    - Ephemeral functional: `crates/storage/ephemeral`
    - Local stub: `crates/storage/local`
    - GitHub stub: `crates/storage/github`
  - Index
    - Tantivy stub: `crates/index/tantivy`
    - SQLite stub: removed in this cycle (consolidate on Tantivy or in-memory default)
  - Crypto facade (passthrough for now): `crates/crypto`
  - Server runtime skeleton: `crates/server`
    - Stdio JSON-RPC handlers: save/get/delete/search; index updated on save/delete.
    - Update handler implemented (patch title/content/tags/type/ttl/score), increments version and updated_at.
  - CLI with `serve|import|sync|reindex|reencrypt` scaffolds: `crates/cli`
  - Compat helpers for basic-memory records: `crates/compat`
  - Testing crate with ephemeral round-trip test: `crates/testing`

- Not Implemented Yet
  - Server MCP tools for `memory.import.basic` and `memory.sync` (CLI provides these flows)
  - Encryption using age (X25519) and key management
  - JSON-RPC websocket transport (and optional HTTP); stdio transport is implemented
  - Conformance fixtures and compatibility suite
  - CI workflows, audit/deny, release pipeline

- Risks / Considerations
  - MSRV bumped to 1.89.0 (stable) across dependencies; toolchain pinned via `rust-toolchain.toml`
  - No blocking IO in async contexts; use spawn_blocking for git/indexing
  - Ensure typed errors map to MCP codes (E_*), redact secrets
  - Index must enforce TTL and encryption constraints

- M1 Completion (stdio vertical slice)
  - Implemented async stdio JSON-RPC server with handlers for `memory.save`, `memory.get`, `memory.delete` using Ephemeral storage.
  - Returns MCP error codes in `error.data.code` (`E_VALIDATION`, `E_NOT_FOUND`, `E_STORAGE_IO`).
  - Minimal tests added for save/get round-trip, validation errors, delete, and method-not-found.

- How To Test (manual)
  - Start server: `cargo run -p mcp-gitmem-cli -- serve --backend ephemeral`
  - Send one JSON per line to stdin:
    - Save: `{ "jsonrpc":"2.0","id":1,"method":"memory.save","params":{"content":"hello","title":"t","type":"note"}}`
    - Get: `{ "jsonrpc":"2.0","id":2,"method":"memory.get","params":{"id":"<mem_id_from_save>"}}`
    - Delete: `{ "jsonrpc":"2.0","id":3,"method":"memory.delete","params":{"id":"<mem_id>","hard":true}}`

- M2 Progress
  - LocalStorage with atomic IO + manifest implemented; CLI `--backend local --root <path>` wired.
  - Minimal in-memory index implemented under Tantivy crate; handlers wire index update/delete and search returns `{items,total}` with Memory items.
  - Real Tantivy-backed engine scaffolded behind feature `real_tantivy` in `mcp-gitmem-index-tantivy`; provides schema, update/delete/search using TopDocs.
  - Real Tantivy engine is now the default (feature enabled by default). Filters for `type` and `tags` are applied in the index query.
  - Time range filtering supported in index using `updated_ts` (from/to RFC3339 parsed in server).
  - Added tests for type/tags filters and time range.
  - Added pagination test (offset/limit) and score sorting test.
  - LocalStorage now uses a cross-process file lock (`meta/LOCK`) around writes and deletes.

- M2 Completed
  - Title boost implemented in real Tantivy query.
  - Capability handshake `initialize` implemented.
  - TTL enforcement, sorting, filtering, pagination covered with tests.
  - Local storage locking added.

---

# M3 Kickoff — GitHub adapter and Importer

- Plan
  - Implement GitHub storage (local clone mode) backed by a working tree path; write JSON files and maintain a manifest; commit/push to be added next.
  - Extend CLI `import` to read JSON/JSONL basic-memory files and save via selected backend; add progress and summary.
  - Batch update to index during import; expose `--root` or `--repo-dir` for storage path.
  - Follow-on: integrate `gix` for commits and optional remote push; batching with `commit_batch_ms`.

- Status
  - GitHub storage with local working tree semantics implemented; conflict artifacts written under `conflicts/<id>/...` and surfaced as `E_CONFLICT` via server.
  - `gitmem import` supports JSON/JSONL via `compat`, with de-duplication and summary counts; `--map-type`, `--dry-run` supported.
  - `gitmem sync --backend github --root <repo> --remote <file://...>` supports push/pull/both against file:// remotes for local testing.
  - CLI now supports serving with GitHub backend in stdio mode: `gitmem serve --backend github --root <repo>`.
  - Added CLI integration test for import into GitHub working tree + sync push/pull via file:// remote.
  - Device branch strategy: HEAD set to `devices/<hostname>`; commits land on that branch.
  - Commit batching: changes within ~1.5s window are squashed into a single batch commit; `flush()` commits pending changes at the end of import.
  - Feature `remote-git` enables real remote push/pull using git2 (HTTPS/SSH), with configurable `github.remote_name` (default `sync`) and credential modes (helper, userpass, token, ssh-agent).
  - Config loader added (`--config`), reading YAML/TOML/JSON via `config` crate with env overrides (`GITMEM__serve__backend`, etc.). Sample at `examples/gitmem.yaml`.
  - Upgraded toolchain to latest stable; updated MSRV docs. Real Tantivy index can be enabled with `--features real_tantivy` (recommended on Linux x86_64 and macOS x86_64; avoid on Apple Silicon due to simdcomp SSSE3 flag in Tantivy 0.2).

# M3 Completed — Summary

- Storage: Local and GitHub adapters functional; GitHub supports file:// sync and optional git2 remote push/pull (`remote-git`).
- Index: Default in-memory index; real Tantivy is optional behind `real_tantivy` (recommended on non‑ARM targets).
- Server: Stdio JSON-RPC handlers for save/get/update/delete/search + resources; conflict mapping to `E_CONFLICT`.
- CLI: `serve`, `import`, `sync` functional with config support and progress reporting.
- Removed SQLite index crate to reduce maintenance surface.
